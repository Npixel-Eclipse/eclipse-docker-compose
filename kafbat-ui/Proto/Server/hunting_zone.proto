syntax = "proto3";
package huntingzone;
import "Common/item_common.proto";
import "Common/property.proto";
import "Server/guild.proto";
import "google/protobuf/timestamp.proto";

option java_multiple_files = true;
option java_package = "eclipse.proto.server.huntingzone";
option java_outer_classname = "HuntingZoneServiceProto";

enum HuntingZoneResultCode {
  FAIL = 0;

  SUCCESS = 1;

  FAIL_ITEM_NOT_FOUND = 2;
  FAIL_NOT_ENOUGH_ITEM = 3;
  FAIL_NOT_ENOUGH_CURRENCY = 4;
  FAIL_INVENTORY_NOT_FOUND = 5;
  FAIL_CANNOT_DELETE_ITEM = 6;
}

enum NewPhase {
  BID_PHASE = 0;
  LAST_OWNER_PHASE = 1;
  MAIN_SEASON_END_PHASE = 2;
}

// kafka key = server_name
message HuntingZoneCache {
  // key = address_id, value = accumulated_gold
  map<int64, int64> accumulated_gold = 1;
}

// kafka key = server_name
message TokenCache {
  // key = battle_name & token_item_name 복합 키, value = 해당 배틀 서버가 드랍한 총 창조석 개수
  map<string, int64> token = 1;

  // token_drop_command의 최근 n개의 transaction_uuid
  repeated string recent_transaction_uuids = 2;
}

message HuntingZoneCommand {
  reserved 3, 6, 8, 9;

  oneof Command {
      HuntingBidCommand hunting_bid_command = 1;
      TokenDecrementCommand token_decrement_command = 7;
      ReleaseTokenCommand release_token_command = 12;
      SettleCommand settle_command = 13;
      UpsertGoldCommand upsert_gold_command = 21;
      UpdateOwnerCommand update_owner_command = 22;
      ForwardEventCommand forward_event_command = 23;
      NewPhaseCommand new_phase_command = 24;
      CreateNewSeasonCommand create_new_season_command = 25;
      RewardResourceCommand reward_resource_command = 26;
      PrePhaseCommand pre_phase_command = 27;
  }
}

message HuntingZoneMetricCommand {
  oneof Command {
    BonusGoldCommand bonus_gold_command = 1;
    ClearMetricCommand clear_metric_command = 2;
  }
}

message HuntingZoneTokenCommand {
  oneof Command {
    TokenDropCommand token_drop_command = 1;
    ClearTokenCommand clear_token_command = 2;
    AssignTokenCommand assign_token_command = 3;
    AcquireTokenCommand acquire_token_command = 4;
  }
}

message HuntingZoneEvent {
  oneof Event {
    SeasonEvent season_event = 1;
  }
}

// key = guild_id
message HuntingBidCommand {
  reserved 3; // guild_name

  int64 hunting_zone_id = 1;
  int64 bid_token_amount = 2;
  int64 guild_id = 4;
  int64 account_id = 9;
  string bid_token_name = 6;
  bytes character_uuid = 7;
  string character_name = 8;
  string server = 10;
  int64 season = 11;
  HuntingZoneResultCode result_code = 99;
}

// hunting-zone 서버가 자기 자신에게 보내는 메시지로
// "마지막 시즌"이 끝나고 정산할 때, 창조석 정보를 지우기 위함
// key = server_name
message ClearTokenCommand {}

// 최초에 창조석 물량을 풀기 위함
// key = server_name
message ReleaseTokenCommand {}

// 해당 season에 대해 정산 명령 내리기 위함
// key = server_name
message SettleCommand {
  int64 season = 1;
  int64 hunting_zone_id = 2;
}

// key = hunting_zone_group_id
message UpsertGoldCommand {
  string server = 1;
  int64 season = 2;
  int64 total_amount = 4;
}

// key = hunting_zone_id
message UpdateOwnerCommand {
  string server = 1;
  int64 owner_season = 2;
  int64 season = 3;
  optional int64 owner_guild_id = 5; // null이면 소유 길드가 없도록 세팅하는 것
}

message ForwardEventCommand {
  bytes hunting_zone_event = 1;
  bytes character_uuid = 2;
}

message NewPhaseCommand {
  NewPhase new_phase = 2;
  bool is_new = 3;
}

message CreateNewSeasonCommand {
  int64 main_season = 1;
  bool start_new_schedule = 2;
}

message RewardResourceCommand {
  int64 season = 1;
  int64 owner_season = 2;
  int64 hunting_zone_id = 3;
  bool main_season_end = 4;
}

// key = server_name
// 새로운 시즌 시작하기 n분 전에 필요한 작업들을 해야하는 경우 쓰임
message PrePhaseCommand {
  int64 new_season = 1;
  int64 previous_season = 2;
  int64 reset_specialty_season = 3;
}

// key = server_name
message BonusGoldCommand {
  int64 amount = 1;
  int64 address_id = 2;
}

// hunting-zone 서버가 자기 자신에게 보내는 메시지로
// 정산할 때 골드 세금을 모두 지우기 위함
// key = server_name
message ClearMetricCommand {
  int64 address_id = 1;
}

// kafka key = server_name
message TokenDropCommand {
  string token_item_name = 1;
  int64 dropped_amount = 2;
  string battle_name = 3;
  string battle_identifier = 5;
  string transaction_uuid = 4;
}

// kafka key = server_name
message TokenDecrementCommand {
  string token_item_name = 1;
  int64 decreased_amount = 2;
  string battle_name = 3;
}

// 메시지 안에 battle_name에 해당하는 battle에 창조석 부여함 (남은 창조석이 있다면)
// key = server_name
message AssignTokenCommand {
  int64 season = 1;
  string battle_name = 2;
  string battle_identifier = 3;
  optional int64 amount = 4; // 이 필드를 비우면 한번에 할당해야하는 개수만큼만 분배
}

// key = server_name
message AcquireTokenCommand {
  string battle_name = 1;
  string battle_identifier = 6;
  string token_item = 2;
  int64 total_dropped_amount = 3;
  int64 season = 4;
  int64 main_season = 5;
}

message SeasonEvent {
  int64 current_season = 1;
  google.protobuf.Timestamp current_bid_start_at = 2;
  google.protobuf.Timestamp current_bid_end_at = 3;
  optional google.protobuf.Timestamp next_bid_start_at = 4;
  optional google.protobuf.Timestamp next_bid_end_at = 5;
}